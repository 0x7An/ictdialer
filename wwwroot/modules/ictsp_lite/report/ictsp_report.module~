<?php
/******************************************************************
* Copyright Â© 2009 ICT Innovations.                               *
* Developed By: Nasir Iqbal                                       *
*             : Tahir Almas                                       *
* Website : http://www.ictinnovations.com/                        *
* Mail : info@ictinnovations.com                                  *
******************************************************************/

// $Id: ictsp_report.module, v 1.0 2009/10/16 18:08:59 ictinnovations Exp $

/**
 * Implementation of hook_menu().
 *
 */

function ictsp_report_menu() {
  $items = array();

  $items['broadcast/report'] = array(
    'title'            => 'Campaing Logs',
    'description'      => 'View CDR / Logs of campaigns',
    'page callback'    => 'ictsp_report_list',
    'page arguments'   => array(false, false),
    'access callback'  => 'ictsp_access',
    'access arguments' => array('ictsp report'),
    'type'             => MENU_NORMAL_ITEM,
  );

  $items['broadcast/report/campaign/%'] = array(
    'title'            => 'Campaign Logs',
    'page callback'    => 'ictsp_report_list',
    'page arguments'   => array(3, false),
    'access callback'  => 'ictsp_access',
    'access arguments' => array('ictsp report'),
    'type'             => MENU_CALLBACK,
  );

  $items['broadcast/report/user/%'] = array(
    'title'            => 'Campaign Logs',
    'page callback'    => 'ictsp_report_list',
    'page arguments'   => array(false, 3),
    'access callback'  => 'ictsp_access',
    'access arguments' => array('ictsp report all'),
    'type'             => MENU_CALLBACK,
  );

  $items['admin/ictsp/report'] = array(
    'title'            => 'Log / Report Settings',
    'description'      => 'Adjust report parameters',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('ictsp_report_admin_settings'),
    'weight'           => 7,
    'access callback'  => 'ictsp_access',
    'access arguments' => array('ictsp report admin'),
  );

  return $items;
}

/**
 * Page function for report
 *
 * It will show a list of cdr entries in form of list
 *
 * @return
 * page html
*/
function ictsp_report_list($campaign_id = false, $uid = false) {
  $value  = '';
  $result = '';
  $sql    = 'SELECT {broadcast_campaign_log}.*, ' .
  		           '{broadcast_campaign}.name,' .
  		           '{broadcast_contact}.phone ' .
  		    'FROM ({broadcast_campaign_log} JOIN {broadcast_campaign} ' .
  	       	          'ON {broadcast_campaign_log}.campaign_id = {broadcast_campaign}.campaign_id)' .
  		          'JOIN {broadcast_contact} ' .
  		              'ON {broadcast_campaign_log}.contact_id = {broadcast_contact}.contact_id';

  if (user_access('ictsp report all')) {
  	if ($uid !== false) {
  	  $sql   = $sql . ' WHERE {broadcast_campaign}.created_by = %d';
  	  $value = $uid;
  	} else if ($campaign_id !== false) {
  	  $sql   = $sql . ' WHERE {broadcast_campaign_log}.campaign_id = %d';
  	  $value = $campaign_id;  
  	}
  } else {
  	$sql = ictsp_db_filter($sql, '{broadcast_contact}.contact_id', 'broadcast_campaign');
  	if ($campaign_id !== false) {
  	  $sql   = $sql . ' AND {broadcast_campaign_log}.campaign_id = %d';
  	  $value = $campaign_id;
  	}
  }

  $header = array(
    array('data' => t('Campaign'),     'field' => 'name'),
    array('data' => t('Contact'),      'field' => 'phone'),
    array('data' => t('Time'),     	   'field' => 'start_at'),
    array('data' => t('Status'),       'field' => 'status'),
    array('data' => t('Cost (units)'), 'field' => 'units'),
  );
  $sql .= tablesort_sql($header);

  $limit  = variable_get('ictsp_report_list_limit', 20);
  $result = pager_query($sql, $limit, 0, NULL, $value);

  while ($cdrlog = db_fetch_array($result)) {
    $row_id = $cdrlog['campaign_log_id'];
    $rows[$row_id][] = l(check_plain($cdrlog['name']), 'broadcast/campaign/'.$cdrlog['campaign_id'].'/edit');
    $rows[$row_id][] = l(check_plain($cdrlog['phone']), 'broadcast/contact/'.$cdrlog['contact_id'].'/edit');
    $rows[$row_id][] = check_plain(format_date($cdrlog['start_at']));
    $rows[$row_id][] = check_plain($cdrlog['status']);
    $rows[$row_id][] = check_plain($cdrlog['units']);
  }
  if (!isset($rows)) {
    $rows[] = array(array('data' => t('No logs have been found.'), 'colspan' => 5));
  }

  $output = theme_table($header, $rows);
  $output .= theme_pager(NULL, $limit);

  return $output;
}

/**
 * Implementation of hook_perm().
 *
 * Defines access permissions that may be assigned to roles and used to restrict
 * access on campaign module.
 */
function ictsp_report_perm() {
  return array(
    'ictsp report',
    'ictsp report all',
    'ictsp report system admin'
  );
}

function ictsp_report_admin_settings() {
  $form['report'] = array(
    '#type'  => 'fieldset',
    '#title' => t('Report Settings')
  );

  $form['report']['ictsp_report_list_limit'] = array(
    '#type'          => 'textfield',
    '#title'         => t('Rows per Page'),
    '#default_value' => variable_get('ictsp_report_list_limit', 20),
    '#description'   => t('Number of rows/entries which should be desplyed in each page'),
  );

  return system_settings_form($form);
}
